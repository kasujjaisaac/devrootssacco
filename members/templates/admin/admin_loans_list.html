{% extends "admin_base.html" %}
{% load static %}

{% block title %}Loans List{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success">Loans List</h2>
        <div class="d-flex align-items-center">
            <!-- Search & Filters -->
            <form method="GET" class="d-flex me-3">
                <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search by Member or Loan ID" value="{{ request.GET.search }}">
                <select name="status" class="form-select form-select-sm me-2">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-success">Filter</button>
            </form>

            <!-- Add Loan Button -->
            <a href="{% url 'admin_add_loan' %}" class="btn btn-success">
                <i class="bi bi-plus-circle me-1"></i> Add Loan
            </a>
        </div>
    </div>

    <!-- Loan Table -->
    <div class="card shadow-sm mb-4 border-success">
        <div class="card-body table-responsive">
            {% if loans %}
            <table class="table table-hover table-striped align-middle">
                <thead class="table-success">
                    <tr>
                        <th>Loan ID</th>
                        <th>Member</th>
                        <th>Member ID</th>
                        <th>Amount (UGX)</th>
                        <th>Current Balance</th>
                        <th>Interest Rate (%)</th>
                        <th>Status</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loan in loans %}
                    <tr class="{% if loan.status == 'pending' %}table-warning{% elif loan.status == 'approved' %}table-success{% elif loan.status == 'rejected' %}table-secondary{% endif %}">
                        <td>{{ loan.id }}</td>
                        <td>{{ loan.member.first_name }} {{ loan.member.last_name }}</td>
                        <td>{{ loan.member.member_id }}</td>
                        <td>{{ loan.principal_amount|floatformat:2 }}</td>
                        <td>{{ loan.current_balance|floatformat:2 }}</td>
                        <td>{{ loan.interest_rate|floatformat:2 }}</td>
                        <td>
                            {% if loan.status == "pending" %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% elif loan.status == "approved" %}
                                <span class="badge bg-success">Approved</span>
                            {% elif loan.status == "rejected" %}
                                <span class="badge bg-secondary">Rejected</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ loan.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ loan.start_date|date:"d M Y" }}</td>
                        <td>{{ loan.end_date|date:"d M Y" }}</td>
                        <td>
                            <a href="{% url 'loan_profile' loan.id %}" class="btn btn-sm btn-primary me-1" title="View Profile">
                                <i class="bi bi-person-lines-fill"></i>
                            </a>
                            <a href="{% url 'loan_repayment' loan.id %}" class="btn btn-sm btn-success" title="Add Repayment">
                                <i class="bi bi-cash-stack"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if loans.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ loans.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Previous</span></li>
                    {% endif %}

                    {% for num in loans.paginator.page_range %}
                        {% if loans.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > loans.number|add:'-3' and num < loans.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if loans.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ loans.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Next</span></li>
                    {% endif %}
                </ul>
            </nav>
            {% else %}
                <p class="text-muted">No loans found.</p>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Optional: highlight rows on hover
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('mouseover', () => row.classList.add('table-info'));
        row.addEventListener('mouseout', () => row.classList.remove('table-info'));
    });
</script>
{% endblock %}
